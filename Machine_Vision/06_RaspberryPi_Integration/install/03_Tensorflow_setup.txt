-- Install linux dependencies for Tensorflow --

sudo apt install python3-dev python3-pip cython gfortran \
                 libhdf5-103 libhdf5-dev hdf5-tools h5utils \
                 pkg-config
sudo pip3 install grpcio  grpcio-tools \
                  absl-py astunparse gast \
                  google-pasta opt-einsum \
                  tensorboard tensorflow-estimator \
                  termcolor wrapt Cython\
                  setuptools pybind11 Sphinx tables

-- Install scipy --

git clone https://github.com/scipy/scipy.git

cd scipy
git clean -xdf
python3 setup.py install --user

-- Install h5py --
cp /usr/lib/aarch64-linux-gnu/hdf5/serial/libhdf5.so /usr/lib/libhdf5.so
git clone https://github.com/h5py/h5py
cd ./h5py; git checkout; python3 setup.py install
pip3 install -v . --no-cache-dir
sudo python3 setup.py build_ext --inplace --hdf5=/usr/lib/aarch64-linux-gnu/hdf5/serial
sudo python3 setup.py install --hdf5=/usr/lib/aarch64-linux-gnu/hdf5/serial


-- Install Tensorflow pip package dependencies --

sudo pip3 install -U --user pip six numpy wheel setuptools mock 'future>=0.17.1'
sudo pip3 install -U --user keras_applications --no-deps
sudo pip3 install -U --user keras_preprocessing --no-deps

-- Get Tensorflow installation files --

git clone https://github.com/tensorflow/tensorflow.git
cd tensorflow

-- Configure tensorflow installer --

./configure

# Get python 3 executable path by:
python3
>>>import sys
>>>print(sys.executable)
>>>exit()
# Typical location: /usr/bin/python3

# Disable every options including XLA JIT during Tensorflow configuration

-- Build Tensorflow installer using Bazel --

# Validated:

bazel --output_user_root=../.cache/bazel/                    \
      --host_jvm_args=-Xmx512m                               \
      --host_jvm_args=-Xms256m                               \
      build --jobs HOST_CPUS-3                               \
            --ram_utilization_factor=50                      \
            --local_cpu_resources=HOST_CPUS-3                \
            --local_ram_resources=HOST_RAM*.5                \
            --config=opt                                     \
            --verbose_failures                               \
            //tensorflow/tools/pip_package:build_pip_package

# Experimental:

bazel build -c opt --copt="-mfpu=neon-vfpv4"                           \
                   --copt="-funsafe-math-optimizations"                \
                   --copt="-ftree-vectorize"                           \
                   --copt="-fomit-frame-pointer"                       \
                   --local_resources 1024,1.0,1.0                      \
                   --verbose_failures                                  \
                   tensorflow/tools/pip_package:build_pip_package

-- Or --
# With explicit environment path:
# Not validated:

bazel build -c opt --copt="-mfpu=neon-vfpv4"                          \
                   --copt="-funsafe-math-optimizations"               \
                   --copt="-ftree-vectorize"                          \
                   --copt="-fomit-frame-pointer"                      \
                   --local_resources 1024,1.0,1.0                     \
                   --verbose_failures                                 \
                   tensorflow/tools/pip_package:build_pip_package     \
                   --action_env="LD_LIBRARY_PATH=${LD_LIBRARY_PATH}"

# Build pip installation wheel:

./bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg

# Install Tensorflow python package:

sudo pip3 install /tmp/tensorflow_pkg/tensorflow*.whl --no-deps